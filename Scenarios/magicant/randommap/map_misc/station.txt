BveTs Map 2.02

// 駅の停止位置を設置する。また、次の地上子を設置する。
//  - この駅の停止位置直前の TASC 地上子
//  - この駅の停止位置直後に設置する、一つ後の駅のための TASC 地上子
//  - 一つ後の駅の停止位置 500 メートル手前の TASC 地上子
//  - 発車合図タイミング設定地上子
// このファイルを include する前に以下の変数を設定しておく必要がある。
//  $location = 停止位置
//  $preceding_station_number = 設置する駅の番号 (始発駅は 0)
//  $following_station_location = 一つ後の駅の停止位置
//  $tasc_long_beacon_type = 前の駅の直後に置く TASC 地上子の番号
//  $tasc_500m_beacon_type = 500 メートル手前に置く TASC 地上子の番号
//  $tasc_11m_beacon_type = 11 メートル手前に置く TASC 地上子の番号
//  $conductor_timing_beacon_type = 発車合図タイミングを設定する地上子の番号
//  $_door_direction = ドアが開く方向
//  $_underrun_limit = 許容されるアンダーラン距離
//  $_overrun_limit = 許容されるオーバーラン距離
// このファイルの中で以下の変数が変更される。
//  $preceding_station_number = 次に設置する (一つ手前の) 駅の番号
//  $following_station_location = 今回設置した駅の停止位置 (= $location)

$location;
	Station['station_' + $preceding_station_number].Put($_door_direction, -$_underrun_limit, $_overrun_limit);
	$preceding_station_number = $preceding_station_number - 1;

// この駅を出た直後に TASC 地上子を置く
	$__l = $location + 11;
	$__d = floor($following_station_location - $__l); // 距離を確実に整数にする
$following_station_location - $__d;
	Beacon.Put($tasc_long_beacon_type, -1, $__d * 1000);

// 一つ後の駅の 500 メートル手前に TASC 地上子を置く。
// 駅が近いときは 500 メートルよりも近い位置に設置することになるが、その場合は
// $tasc_long_beacon_type の方の地上子が直後に来るので停止位置がずれることはない。
	$__l = $location + 10.99;
$following_station_location - 500;
(distance + $__l + abs(distance - $__l)) / 2; // max(distance, $__l)
	Beacon.Put($tasc_500m_beacon_type, -1, 0);

// 11 メートル手前に TASC 地上子を置く
$location - 11;
	Beacon.Put($tasc_11m_beacon_type, -1, 11000);

// 発車合図タイミング設定地上子も置く
$location - 11;
	Beacon.Put($conductor_timing_beacon_type, -1, floor(abs(rand(8) - 3) + 0.5));

$following_station_location = $location;

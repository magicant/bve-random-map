# 開発者用説明書

このファイルではこの路線データの技術的内部仕様を説明する。

## ファイル構成

この路線データのファイルは以下のサブフォルダーに分かれている。

 - map
 - map_misc
 - map_parts
 - signals
 - stations
 - structures

signals フォルダーには信号現示リストが入っている。
stations フォルダーには停車場リストが入っている。

マップファイルはいくつかのフォルダーに分かれている。

Git のレポジトリーをチェックアウトした直後は、map フォルダーには build.sh というスクリプトファイルしか入っていない。このスクリプトを実行することで、map フォルダー内にマップファイルがたくさん生成される。生成されたマップファイルは、シナリオファイルで `Route = ...` に指定する。これには複数のマップファイルを指定でき、それによりシナリオ起動時にランダムにマップファイルが選択される。こうして毎回異なるマップが読み込まれる。

map_parts フォルダーにあるファイルは、パートファイルと呼んでいる。パートファイルは、map フォルダーにあるマップファイルから `include` される。パートファイルはその中で数百メートル分 (基本的には一閉塞分) の線路を生成し、その区間内にストラクチャーや地上子を配置する。マップファイルがパートファイルをどんどん `include` することで順次路線が生成されてゆくということである。どのパートファイルをどの順番で `include` するかはマップファイルによって異なる。また同じパートファイルでも内部で `rand` 関数を使用して様々なパラメーターをランダムに決定するため異なる線形や地形が生成される。

map_misc フォルダーにあるファイルは上記以外のマップファイルであり、基本的にはパートファイルから `include` される。ここにあるファイルは変数を初期化したり地上子をまとめて設置したりといった共通処理を行う。

## 停車場リスト

停車場リストファイルは `stations_<時刻>h_<ID>.csv` 形式のファイル名をしており、例えば `stations_9h_0.csv` のようになる。

`<時刻>` は最初の駅を出発する時刻が何時台かを示しており、例えば `stations_9h_0.csv` は最初の駅を午前 9 時台に出発するダイヤである。

`<ID>` は停車場リストのバリエーションの番号である。ID ごとに停車場リストの中身 (特に駅名) が異なっている。

マップファイルからランダムに停車場リストファイルを選んで読み込むことで、駅名とダイヤが毎回変化するようにしてある。停車場リストファイルの内容を動的に生成することはできないので、駅名やダイヤはファイルごとに一定である。また、マップファイルからは停車場リストに書かれた内容を読み取ることができないので、最初の駅の出発時刻は時からおおよその分と秒が機械的に決まるようにしてある (こうしないと、自車のダイヤと先行列車のダイヤを合わせることができない)。具体的にいうと、最初の駅の出発時刻は必ず以下のどれか (もしくは高々その数分前) となる。

 -  5:31:00
 -  6:51:35
 -  7:12:10
 -  8:32:45
 -  9:53:20
 - 10:13:55
 - 11:34:30
 - 12:55:05
 - 13:15:40
 - 14:36:15
 - 15:56:50
 - 16:17:25
 - 17:38:00
 - 18:58:35
 - 19:19:10
 - 20:39:45
 - 21:00:20
 - 22:20:55
 - 23:41:30

また、最初の駅のパートファイルにおいて、先行列車は初期の `$pretrain_time` から 90 秒以内に最初の駅の出発信号より先に進んでいなければならない。(そうしないと先行列車が自車より後ろの位置に来る恐れがある)

## マップファイルの生成

map フォルダーにある build.sh というシェルスクリプトファイルを実行することでマップファイルが大量に生成される。また、シナリオファイルに記載すべき `Route = ...` の値が標準出力に出力される。

このスクリプトは bash 用であり、Cygwin 等の Unix 系環境で実行する必要がある。(Windows 標準の cmd.exe や PowerShell では実行できない。)

なお、生成されるマップファイルが読み込むパートファイルの種類や順番はスクリプトを実行するたびに毎回ランダムに変化する。

### パートファイルの選択

各パートファイルには、`//NEXT: <ファイル名>` という形式のコメントが一つ以上書かれている。これにより、そのパートファイルが `include` された後にどのパートファイルが `include` されるかが決まる。コメントが複数ある場合はそれらの中からランダムに次のパートファイルが選択される。同じファイル名を指すコメントを何度も書くことでそのファイルが選ばれる確率が上がる。

パートファイルの中に `//DUMMY` というコメントがある場合、そのパートファイルはダミーとみなされる。ダミーのパートファイルは `include` されず、そこに書かれている `//NEXT:` のファイル名に従ってただ次のパートファイルが選択される。

ダミーファイルは、主に複数のパートファイルからランダムに選ぶのをやりやすくするために使用する。例えば grassland_s_any.txt というダミーファイルには名前が grassland_s で始まる種々のパートファイル (どれも草原を走る単線のパート) が次の候補として書かれている。これらのパートファイルをいちいち `//NEXT:` に列挙する代わりにダミーファイルを `//NEXT:` に指定することで、コメントの記述量も減るし、また新たに草原を走る単線のパートファイルが増えたときにはダミーファイルを書き換えるだけで他のパートファイルの続きとして候補に加えることができる。

なお、各マップファイルで最初に読み込まれるパートファイルは必ず any.txt で、これは全てのパートファイルからランダムに選択するためのダミーのファイルである。

パートファイルの中に `//STATION` というコメントがある場合、そのパートファイルは駅である。駅のパートファイルはちょうど一つの `Station[...].Put(...)` 文を含む。パートファイルが駅であるかどうかの区別は build.sh が生成するマップファイルの長さに影響する。一定数の駅を `include` したところでマップファイルが終了する。

## マップファイルで使う変数

マップファイルで使う変数は、名前によりスコープを区別している。

 - `$` の直後にアルファベットが来る変数 (例: `$distance`) は全てのファイルにわたって横断的に使用する変数である。このタイプの変数はパートファイル間で値が引き継がれる。
 - `$` の直後に一つ `_` が付く変数 (例: `$_begin`) はそのパートファイル内で固有の変数である。このタイプの変数はそれが定義されたパートファイル内でのみ使用され、他のパートファイルで使用されることはない。ただし、そのパートファイルが `include` するファイルと値をやり取りするために使用されることはある。
 - `$` の直後に二つ `_` が付く変数 (例: `$__start_hour`) は、map_misc ディレクトリーにあるマップファイルの中で定義され、そのファイル内のみで使用される。

### グローバル変数

`$` の直後にアルファベットが来る変数はパートファイル間で様々なデータを引き継ぐために使用する。以下はそのような変数の一覧である。一つのパートファイルの処理が終わり次のパートファイルの処理に移るとき、変数の値は以下に説明する通りになっている必要がある。

 - `$distance` = パートファイルが切り替わる地点の位置。
 - `$next_station_number` = 次に駅のパートファイルが `include` された時に生成される駅の番号。駅の番号は初めから順に 0, 1, 2... と数える。
 - `$previous_station_location` = 一つ前の駅の停止位置。
 - `$previous_section_location` = 一つ前の閉塞の開始位置。
 - `$pretrain_time` = `$distance` の位置を先行列車が通過する時刻 (0 時からの秒数)。

以下は全てのパートファイルで使われる変数ではあるが、最初のパートファイルが `include` される前に初期化され、各パートファイルの中では変更されない。

 - `$max_speed` = 路線の最高速度 (km/h)。5 の倍数。
 - `$signal_index_0`, ..., `$signal_index_5` = 先行列車が 0, ..., 5 区間先の閉塞にある時の信号インデックス。
 - `$tasc_long_beacon_type` = 前の駅の停止位置の 11 メートル先に設置する TASC 地上子の種別番号。
 - `$tasc_11m_beacon_type` = 停車駅の停止位置の 11 メートル手前に設置する TASC 地上子の種別番号。
 - `$ats_stop_beacon_type` = ATS-P 即時停止地上子の種別番号。
 - `$ats_stop_beacon_section` = ATS-P 即時停止地上子に対応させる閉塞。
 - `$ats_update_1_beacon_type` = 一つ先の閉塞の信号現示を送るための地上子の種別番号。閉塞の 25, 50, 85, 130, 180, 280, 600 メートル手前に設置される。
 - `$ats_update_2_beacon_type` = 二つ先の閉塞の信号現示を送るための地上子の種別番号。閉塞の 25, 50, 85, 130, 180, 280, 600 メートル手前に設置される。
 - `$ats_update_m1_beacon_type` = この先の停止信号の位置を送るための地上子の種別番号。閉塞の 25, 50, 85, 130, 180, 280, 600 メートル手前に設置される。
 - `$ats_update_1_beacon_value`, `$ats_update_2_beacon_value`, `$ats_update_m1_beacon_value` = 上記それぞれの地上子に送る値。
 - `$ats_update_transponder` = 上記地上子のストラクチャーキー。
 - `$ballast_5m_count` = `ballast_5m_<ID>` ストラクチャーのバリエーション。

なお、距離の単位は全てメートルである。

## 計算式

 - max(x, 0) = (x + abs(x)) / 2
 - min(x, 0) = (x - abs(x)) / 2
 - max(x, y) = (x + y + abs(x - y)) / 2
 - min(x, y) = (x + y - abs(x - y)) / 2
 - (x が 0 または 1 であるとき) if x = 0 then 1 else 0 = 1 - x
 - (x が 0 または 1 であるとき) if x = 0 then 0 else y = x * y
 - if x is integer then 0 else 1 = ceil(x) - floor(x)
 - (x が 0 でないとき) if x > 0 then 1 else -1 = x / abs(x)
 - if x = 0 then 0 else 1 = ceil(min(abs(x), 1))
 - (0 <= x <= N のとき) if x = 0 then 0 else 1 = ceil(x / N)
